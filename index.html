<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>hello</title>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="client.js"></script>
</head>
<body>
<canvas id="MainCanvas" width="490" height="220"></canvas>
<div id="chat">
</div>
<input type="text" id="message" />
<script>
    jQuery(function($)
    {
        var socket=io.connect();
        var $chat= $('#chat');
        var $message=$('#message');

        $message.blur(function(e){
            e.preventDefault();
           socket.emit('send message',$message.val());
            $message.val('');
        });
        socket.on('new message', function(data){
            $chat.append(data + "<br/>");
        });

        var clickX = new Array();
        var clickY = new Array();
        var clickDrag = new Array();
        var paint;
        var context = $("#MainCanvas")[0].getContext("2d");
        var ownColor='#'+Math.random().toString(16).substr(-6);
        context.strokeStyle = ownColor;
        context.lineJoin = "round";
        context.lineWidth = 5;
        //socket.emit('new user',context);

        $("#MainCanvas").mousedown(function(e){
            var mouseX = e.pageX - this.offsetLeft;
            var mouseY = e.pageY - this.offsetTop;

            paint = true;
            addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
            redraw();
        });
        $("#MainCanvas").mousemove(function(e){
            if(paint){
                addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
                redraw();
            }
        });
        $("#MainCanvas").mouseup(function(e){
            paint = false;
            clickX=[];
            clickY=[];
            clickDrag=[];
        });

        $("#MainCanvas").mouseleave(function(e){
            paint = false;
        });
        function addClick(x, y, dragging)
        {
            clickX.push(x);
            clickY.push(y);
            clickDrag.push(dragging);
        }

        function redraw(){
            //context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
            context.strokeStyle=ownColor;
            context.beginPath();
            if(clickX.length>1)
            {
                var drawpath={};

                if(clickDrag[clickX.length-1]) {
                    context.moveTo(clickX[clickX.length - 2], clickY[clickX.length - 2]);
                    drawpath.moveToX=clickX[clickX.length - 2];
                    drawpath.moveToY=clickY[clickX.length - 2];
                }
                else
                {
                    context.moveTo(clickX[clickX.length-2]-1, clickY[clickX.length-1]);
                    drawpath.moveToX=clickX[clickX.length-2]-1;
                    drawpath.moveToY=clickY[clickX.length-1];

                }
                context.lineTo(clickX[clickX.length-1], clickY[clickX.length-1]);
                drawpath.lineToX=clickX[clickX.length-1];
                drawpath.lineToY=clickY[clickX.length-1];
                drawpath.color=ownColor;
                socket.emit('send coordinates',drawpath);
            }
            context.closePath();
            context.stroke();

            /*for(var i=0; i < clickX.length; i++) {
                context.beginPath();
                var drawpath={};

                if(clickDrag[i] && i){
                   context.moveTo(clickX[i-1], clickY[i-1]);
                    drawpath.moveToX=clickX[i-1];
                    drawpath.moveToY=clickY[i-1];
                    //socket.emit('send coordinates',{"clickX":clickX[i-1],"clickY":clickY[i-1]});
                }else{
                    context.moveTo(clickX[i]-1, clickY[i]);
                    drawpath.moveToX=clickX[i]-1;
                    drawpath.moveToY=clickY[i];
                    //socket.emit('send coordinates',{"clickX":clickX[i]-1,"clickY":clickY[i]});
                }
                context.lineTo(clickX[i], clickY[i]);
                drawpath.lineToX=clickX[i];
                drawpath.lineToY=clickY[i];
                drawpath.color=ownColor;
                socket.emit('send coordinates',drawpath);

                context.closePath();
                context.stroke();
            }*/
        }

        socket.on('draw', function(data){
            context.beginPath();
            //console.log(data);
            context.strokeStyle=data['color'];
            context.moveTo(data['moveToX'],data['moveToY']);
            context.lineTo(data['lineToX'],data['lineToY']);
            context.closePath();
            context.stroke();

        });
    });
</script>
</body>
</html>